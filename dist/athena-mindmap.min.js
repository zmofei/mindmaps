var AthenaMindmap;(()=>{"use strict";var t=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e={};(()=>{var i,o;t(e),function(t){t.Root="ROOT",t.Node="NODE"}(i||(i={})),function(t){t.Edit="Edit",t.Default="Default"}(o||(o={}));var n=10,s=function(){function t(){var t=this,e=this.box=document.createElement("div");e.style.position="absolute",e.style.zIndex="999",this.dom=document.createElement("div"),this.dom.innerHTML="Hello",this.dom.contentEditable="true",this.dom.style.font="14px Arial",this.dom.style.position="absolute",this.dom.style.left="1px",this.dom.style.top="0",this.dom.style.whiteSpace="nowrap",this.dom.style.minWidth="40px",this.dom.style.transform="translate(0, -100%)",e.appendChild(this.dom),document.body.style.position="relative",document.body.appendChild(e),this.dom.addEventListener("keydown",(function(e){"Tab"===e.key&&(e.returnValue=!1,t.events.new=t.events.new||[],t.events.new.forEach((function(e){e({father:t.changeNode.id,after:null})})))})),this.dom.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.returnValue=!1,t.events.new.forEach((function(e){e({father:t.changeNode.fatherId,after:t.changeNode.id})})))})),this.dom.addEventListener("input",(function(e){t.changeNode.context=t.dom.innerText.replace(/\n/gi,"")})),this.events={}}return t.prototype.show=function(t,e,i,o,n,s){if(this.lastPosition,this.changeNode=s,this.box.style.display="inline-block",this.dom.style.transformOrigin="bottom left",this.box.style.transform="translate("+t+"px, "+e+"px) scale("+n/2+")",s.id!==this.lastNodeId){this.dom.innerText=s.context;var h=document.createRange(),r=window.getSelection();h.selectNodeContents(this.dom),r.removeAllRanges(),r.addRange(h),this.lastNodeId=s.id}this.lastPosition={x:t,y:e,scale:n}},t.prototype.hide=function(){this.lastNodeId=null,this.box.style.display="none"},t.prototype.onChange=function(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)},t}(),h=function(){return(h=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},r=new s,a=function(){function t(t,e){var n;void 0===e&&(e={context:"",fatherId:null});var s=(+new Date).toString(32)+Math.random().toString(32);this.id=s,this.ctx=t,this.x=0,this.y=0,this.type=null!==(n=e.type)&&void 0!==n?n:i.Node,this._state=o.Default,this.context=e.context,this.fatherId=e.fatherId||null,this.childrenSumHeight=this.outerHeight}return t.prototype.computerSize=function(){this.ctx.font="14px Arial";var t=this.ctx.measureText(this._context);this.contextWidth=Math.max(t.width,40),this.contextHeight=t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,this.boxWidth=this.contextWidth+20,this.boxHeight=this.contextHeight+20,this.outerHeight=this.boxHeight+20,this.outerWidth=this.boxWidth+20},Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){var e,i,o;this._context=t,this.computerSize(),null===(e=this.bindTree)||void 0===e||e.shakeTree(),null===(o=null===(i=this.bindTree)||void 0===i?void 0:i.graph)||void 0===o||o.draw()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},set:function(t){t===o.Edit?this.bindTree.editoringNode=this:this.bindTree.editoringNode=null,this._state=t},enumerable:!1,configurable:!0}),t}(),d=function(){function t(t,e){var o=this;void 0===e&&(e={x:0,y:0,context:"",type:i.Root}),this.graph=t;var n=this.ctx=t.ctx,s=new a(n,h(h({},e),{type:i.Root}));this.rootid=s.id,this.tree={},this.tree[this.rootid]=s,this.nodesRef=this.nodesRef||{},this.nodesRef[this.rootid]=s,s.fatherId&&this.tree[s.fatherId]&&(s.father=this.tree[s.fatherId]),s.bindTree=this,this.editor=r,r.onChange("new",(function(t){var e=t.father,i=t.after;o.addNode({context:"New Node"},e,i,!0),console.log("add node",e,i)}))}return t.prototype.addNode=function(t,e,i,o){void 0===t&&(t={context:""});var n=e||this.rootid,s=this.nodesRef[n],r=new a(this.ctx,h(h({},t),{fatherId:n})),d=s.children=s.children||[];if(console.log("\t",t,e,i,o),i){var l=d.findIndex((function(t){return t.id===i}));if(-1===l)return!1;d.splice(l+1,0,r)}else d.push(r);o&&(this.graph.selected&&(this.graph.selected.selected=!1),this.graph.selected=r,r.selected=!0,this.editoringNode=r),this.nodesRef[r.id]=r,r.fatherId&&this.tree[r.fatherId]&&(r.father=s),r.bindTree=this;for(var c=d.length<=1?0:r.outerHeight,f=r;f;){var x=f.fatherId,u=this.nodesRef[x];x&&u?(u.childrenSumHeight+=c,f=u):f=null}return this.shakeTree(),this.graph.draw(),console.log("new item id",r.id),r.id},t.prototype.shakeTree=function(){for(var t=this,e=[{info:{x:0,fatherY:0,fatherX:0},items:Object.keys(this.tree).map((function(e){return t.nodesRef[e]}))}],i=[],n=[],s=[],h=function(){var t=e.shift(),h=t.info,r=t.items,a=0;r.forEach((function(t,e){a+=t.childrenSumHeight}));var d=h.fatherY-a/2,l=1===r.length;r.forEach((function(t,r){var a;l?a=h.fatherY:(a=d+t.childrenSumHeight/2,d+=t.childrenSumHeight),t.x=h.x,t.y=a,i.push([t,{x:h.x,y:a}]),n.push([t,{x:h.x,y:a}]),h.father&&s.push([h.fatherX+h.father.boxWidth,h.fatherY,h.x,a]),t.state,o.Edit;var c=t.children;c&&e.push({info:{x:h.x+t.boxWidth+100,fatherY:a,fatherX:h.x,father:t},items:c})}))};e.length>0;)h();this.boardList=i,this.textList=n,this.linkList=s},t.prototype.drawBoard=function(){var t=this,e=this.boardList,o=this.ctx,s=[];o.save();var h={};e.forEach((function(t){var e=t[0];e.selected&&s.push(e),h[e.type]=h[e.type]||{type:e.type,list:[]},h[e.type].list.push(t)})),Object.keys(h).forEach((function(e){var o=h[e];!function(t,e,o){e.save(),e.strokeStyle="#e99b47",t===i.Root?(e.beginPath(),o.forEach((function(t){var i=t[0],o=t[1],s=(i.context,i.boxHeight),h=i.boxWidth,r=(i.outerHeight,o.x),a=o.y;a+=i.boxHeight/2,e.translate(r+n,a-i.boxHeight/2),e.lineWidth=4,e.moveTo(-10,0),e.lineTo(-10,-s/2+6),e.arc(-4,-s/2+6,6,Math.PI,1.5*Math.PI),e.lineTo(h-n-6,-s/2),e.arc(h-n-6,-s/2+6,6,1.5*Math.PI,2*Math.PI),e.lineTo(h-n,s/2-6),e.arc(h-n-6,s/2-6,6,2*Math.PI,.5*Math.PI),e.lineTo(-4,s/2),e.arc(-4,s/2-6,6,Math.PI/2,Math.PI),e.lineTo(-10,0),e.translate(-(r+n),-(a-i.boxHeight/2))})),e.closePath(),e.stroke(),e.fillStyle="white",e.fill()):t===i.Node&&(e.beginPath(),o.forEach((function(t){var i=t[0],o=t[1],s=(i.context,i.boxHeight),h=(i.boxWidth,i.outerHeight,o.x),r=o.y;e.translate(h+n,r-i.boxHeight/2),e.lineCap="round",e.lineWidth=2,e.moveTo(-10,s/2),e.lineTo(i.boxWidth-n,s/2),e.translate(-(h+n),-(r-i.boxHeight/2))})),e.closePath(),e.stroke()),e.restore()}(o.type,t.ctx,o.list)})),o.restore(),o.save(),null==s||s.forEach((function(e){t.ctx.fillStyle="rgba(0,102,255,0.2)",e.type===i.Root?t.ctx.fillRect(e.x,e.y-e.boxHeight/2,e.boxWidth,e.boxHeight):t.ctx.fillRect(e.x,e.y-e.boxHeight,e.boxWidth,e.boxHeight)})),o.restore(),window.debug&&e.forEach((function(e){var i=e[0],s=e[1],h=s.x,r=s.y;o.save(),o.fillStyle="red",o.translate(h,r),o.fillRect(-2,-2,4,4),o.restore(),o.save(),o.fillStyle="red",o.translate(h+n,r-i.boxHeight/2),t.ctx.strokeStyle="red",o.strokeRect(-10,-i.childrenSumHeight/2,i.boxWidth,i.childrenSumHeight),o.restore(),o.save(),o.translate(h,r),o.translate(n,-i.boxHeight/2),o.strokeRect(0,-i.contextHeight/2,i.contextWidth,i.contextHeight),o.restore(),o.save(),o.strokeStyle="grey",o.translate(h,r),o.translate(-10,-i.boxHeight-10),o.strokeRect(0,0,i.outerWidth,i.outerHeight),o.restore(),o.save(),o.strokeStyle="yellow",o.translate(h,r),o.translate(0,-i.boxHeight),o.strokeRect(0,0,i.boxWidth,i.boxHeight),o.restore(),o.save(),o.translate(h+n,r-i.boxHeight/2),t.ctx.fillStyle="red",o.font="10px Arial",o.fillText(i.childrenSumHeight.toFixed(2).toString(),i.boxWidth,20-i.boxHeight),o.fillText(i.outerHeight.toFixed(2).toString(),i.boxWidth,20-i.boxHeight+10),o.fillText(i.x.toFixed(0).toString()+","+(i.y||0).toFixed(0).toString()+" ",i.boxWidth,20-i.boxHeight+20),o.translate(-(h+n),-(r-i.boxHeight/2)),o.restore()}))},t.prototype.drawText=function(){var t=this,e=this.textList,o=this.ctx;o.save(),o.textAlign="left",o.textBaseline="middle",e.forEach((function(e){var s=e[0],h=e[1];if(s===t.editoringNode)return!1;var r=h.x,a=h.y;s.type===i.Root&&(a+=s.boxHeight/2),o.translate(r+n,a-s.boxHeight/2);var d=s.context;s.boxHeight,s.boxWidth,s.outerHeight,o.font="14px Arial",o.fillText(d,0,0),o.translate(-(r+n),-(a-s.boxHeight/2))})),o.restore()},t.prototype.drawLink=function(){var t=this.linkList,e=this.ctx;e.save(),e.strokeStyle="#e99b47",e.beginPath(),t.forEach((function(t){var i=t[0],o=t[1],n=t[2],s=t[3],h=Math.abs(s-o),r=(i+n)/2,a=s<o;e.moveTo(i,o),e.lineTo(r-6,o),h/2>=6?(e.quadraticCurveTo(r,o,r,o+(a?-6:6)),e.lineTo(r,s+(a?6:-6)),e.quadraticCurveTo(r,s,r+6,s)):e.bezierCurveTo(r,o,r,s,r+6,s),e.lineTo(n,s)})),e.stroke(),e.closePath()},t.prototype.updateEditor=function(){var t=this.editoringNode,e=window.devicePixelRatio||1;if(t){var o=this.ctx.getTransform(),s=o.a,h=o.e,a=o.f,d=t.x,l=t.y,c=t.contextWidth,f=t.contextHeight,x=[(h+d*s)/e,(a+l*s)/e],u=x[0],v=x[1],g=0,p=0;t.type===i.Node?(g=n*(s/e),p-=n*(s/e)):t.type===i.Root&&(g=n*(s/e),p+=s/e*8),r.show(u+g,v+p,c,f,s,t)}else r.hide()},t.prototype.draw=function(){this.drawBoard(),this.drawText(),this.drawLink(),this.updateEditor()},t}(),l=function(){function t(t){this.dpr=window.devicePixelRatio||1,this.scale=this.dpr,this.size=t,this.offset={x:t.width/2*this.scale,y:t.height/2*this.scale},this.events={};var e=this.canvas=document.createElement("canvas");this.ctx=e.getContext("2d"),window.ctx=this.ctx,this.adjustCanvs(e,t),this.bindEvent();var i=window.testNode=new d(this,{x:0,y:0,context:"Hello"}),o=0;o=i.addNode({context:"Robin Ma"}),o=i.addNode({context:"CKY"}),i.addNode({context:"Name: kaiyue"},o),o=i.addNode({context:"Mofei Zhu"}),i.addNode({context:"Name: Mofei"},o),i.addNode({context:"Sex: Fame"},o),o=i.addNode({context:"Age: 18"},o),console.log("add after",o),i.addNode({context:"1"},o),o=i.addNode({context:"Mll"}),i.nodesRef[o],o=i.addNode({context:"Ml2"}),this.nodeTrees=[i]}return t.prototype.adjustCanvs=function(t,e){t.style.width=e.width+"px",t.style.height=e.height+"px",t.width=e.width*this.dpr,t.height=e.height*this.dpr,this.ctx.translate(this.offset.x,this.offset.y),this.ctx.scale(this.dpr,this.dpr)},t.prototype.bindEvent=function(){var t=this,e=this.canvas,n="DONE",s=null,h=null,r=null,a=null;e.addEventListener("mousedown",(function(e){var i;n="PREPARE",r=s=e.offsetX,a=h=e.offsetY,t.editItem&&(null===(i=t.editItem)||void 0===i||(i.state=o.Default),t.editItem=null,t.draw())})),e.addEventListener("mousemove",(function(e){if("PREPARE"===n||"MOVING"===n){var o=t,s=o.dpr,h=o.scale,d=(o.offset,e.offsetX-r),l=e.offsetY-a,c=h/s;a=e.offsetY,r=e.offsetX,n="MOVING",t.ctx.translate(d/c,l/c),t.draw()}else{var f=(e.offsetX*t.dpr-t.offset.x)/t.scale,x=(e.offsetY*t.dpr-t.offset.y)/t.scale,u=null;t.nodeTrees.forEach((function(t){for(var e=t.tree,o=[Object.keys(e).map((function(t){return e[t]}))];o.length>=1;)for(var n=0,s=o.pop();n<s.length;n++){var h=s[n],r=Math.max(Math.abs(h.x),0)<Math.abs(f),a=Math.abs(h.y||0)<Math.abs(x)+h.outerHeight,d=h.children;if(r&&a){var l=f>=h.x&&f<=h.x+h.boxWidth,c=h.type===i.Root?h.boxHeight/2:0,v=x>=h.y-h.boxHeight+c&&x<=h.y+c;if(l&&v){u=h,o.length=0;break}d&&o.push(d)}}})),t.canvas.style.cursor=u?"pointer":"default",t.hover=u}})),e.addEventListener("mouseup",(function(e){e.preventDefault(),n="DONE",r=a=null;var i=t.ctx.getTransform();t.scale=i.a,t.offset={x:i.e,y:i.f}})),e.addEventListener("wheel",(function(e){var i=t,o=i.dpr,n=i.scale,s=i.offset;e.preventDefault();var h=Math.pow(1.01,-e.deltaY),r=n/o;ctx.setTransform(n,0,0,n,s.x,s.y),t.ctx.translate(-s.x/n+e.offsetX/r,-s.y/n+e.offsetY/r),t.ctx.scale(h,h),t.ctx.translate(-(-s.x/n+e.offsetX/r),-(-s.y/n+e.offsetY/r));var a=t.ctx.getTransform();t.scale=a.a,t.offset={x:a.e,y:a.f},t.draw()})),e.addEventListener("click",(function(e){var i,n,r;if(Math.abs(e.offsetX-s)>5||Math.abs(e.offsetY-h)>5)return!1;t.hover&&t.selected===t.hover?(t.hover.state=o.Edit,t.editItem=t.hover):t.hover!==t.editItem&&(null===(i=t.editItem)||void 0===i||(i.state=o.Default),t.editItem=null),null===(n=t.selected)||void 0===n||(n.selected=!1),t.selected=t.hover,null===(r=t.selected)||void 0===r||(r.selected=!0),t.draw()}))},t.prototype.draw=function(){var t=this.ctx;if(t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="#f3f3f4",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore(),window.debug){this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="red",this.ctx.lineWidth=2,this.ctx.moveTo(0,-5),this.ctx.lineTo(0,5),this.ctx.moveTo(-5,0),this.ctx.lineTo(5,0),this.ctx.stroke(),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.strokeStyle="#ddd";for(var e=Math.round(this.size.width/10),i=-e;i<e;i+=1)this.ctx.moveTo(-10*i,-this.size.height),this.ctx.lineTo(-10*i,this.size.height);var o=Math.round(this.size.height/10);for(i=-o;i<o;i+=1)this.ctx.moveTo(-this.size.width,-10*i),this.ctx.lineTo(this.size.width,-10*i);this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()}(this.nodeTrees||[]).forEach((function(t){t.draw()}))},t}(),c=function(t){var e=getComputedStyle(t),i={width:parseFloat(e.width),height:parseFloat(e.height)};this.coreCanvas=new l(i),this.canvas=this.coreCanvas.canvas,this.ctx=this.coreCanvas.ctx,this.coreCanvas.draw()};new function(t,e){this.container=document.getElementById("container"),this.graph=new c(this.container),console.log("Hello Athena!"),this.container.appendChild(this.graph.canvas)}("container")})(),AthenaMindmap=e})();
//# sourceMappingURL=athena-mindmap.min.js.map