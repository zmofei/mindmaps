var AthenaMindmap;(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{var i,o;t.r(e),t.d(e,{AthenaMindmap:()=>f}),function(t){t.Root="ROOT",t.Node="NODE"}(i||(i={})),function(t){t.Edit="Edit",t.Default="Default"}(o||(o={}));var n=10,s=function(){function t(){var t=this;this.chagneEvents=[];var e=this.box=document.createElement("div");e.style.position="absolute",e.style.zIndex="999",this.dom=document.createElement("div"),this.dom.innerHTML="Hello",this.dom.contentEditable="true",this.dom.style.font="14px Arial",this.dom.style.position="absolute",this.dom.style.left="0",this.dom.style.top="0",this.dom.style.whiteSpace="nowrap",this.dom.style.transform="translate(0, -100%)",e.appendChild(this.dom),document.body.style.position="relative",document.body.appendChild(e),this.dom.addEventListener("keypress",(function(t){"Enter"===t.key&&(t.returnValue=!1)})),this.dom.addEventListener("input",(function(e){console.log(t.dom.innerText.replace(/\n/gi,"")),t.changeNode.context=t.dom.innerText.replace(/\n/gi,"")}))}return t.prototype.show=function(t,e,i,o,n,s){var r=this.lastPosition||{x:0,y:0,scale:0};if(this.changeNode=s,this.box.style.display="inline-block",this.dom.style.transformOrigin="bottom left",this.box.style.transform="translate("+t+"px, "+e+"px) scale("+n/2+")",t!==r.x||e!==r.y||n!==r.scale){this.dom.innerText=s.context;var h=document.createRange(),a=window.getSelection();h.setStart(this.dom,0),h.collapse(!0),a.removeAllRanges(),a.addRange(h)}this.lastPosition={x:t,y:e,scale:n}},t.prototype.hide=function(){this.box.style.display="none"},t.prototype.change=function(t){this.chagneEvents.push(t)},t}(),r=function(){return(r=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},h=new s,a=function(){function t(t,e){var n;void 0===e&&(e={context:"",fatherId:null});var s=(+new Date).toString(32)+Math.random().toString(32);this.id=s,this.ctx=t,this.x=0,this.y=0,this.type=null!==(n=e.type)&&void 0!==n?n:i.Node,this._state=o.Default,this.context=e.context,this.fatherId=e.fatherId||null,this.childrenSumHeight=this.outerHeight}return t.prototype.computerSize=function(){this.ctx.font="14px Arial";var t=this.ctx.measureText(this._context);this.contextWidth=t.width,this.contextHeight=t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,this.boxWidth=this.contextWidth+20,this.boxHeight=this.contextHeight+20,this.outerHeight=this.boxHeight+20,this.outerWidth=this.boxWidth+20},Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){var e,i,o;this._context=t,this.computerSize(),null===(e=this.bindTree)||void 0===e||e.shakeTree(),null===(o=null===(i=this.bindTree)||void 0===i?void 0:i.graph)||void 0===o||o.draw()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},set:function(t){t===o.Edit?this.bindTree.editoringNode=this:this.bindTree.editoringNode=null,this._state=t},enumerable:!1,configurable:!0}),t}(),d=function(){function t(t,e){var o=this;void 0===e&&(e={x:0,y:0,context:"",type:i.Root}),this.graph=t;var n=this.ctx=t.ctx,s=new a(n,r(r({},e),{type:i.Root}));this.rootid=s.id,this.tree={},this.tree[this.rootid]=s,this.nodesRef=this.nodesRef||{},this.nodesRef[this.rootid]=s,s.fatherId&&this.tree[s.fatherId]&&(s.father=this.tree[s.fatherId]),s.bindTree=this,h.change((function(t){o.shakeTree(),o.draw()}))}return t.prototype.addNode=function(t,e){void 0===t&&(t={y:0,context:""});var i=e||this.rootid,o=this.nodesRef[i],n=new a(this.ctx,r(r({},t),{fatherId:i}));o.children=o.children||[],o.children.push(n),this.nodesRef[n.id]=n,n.fatherId&&this.tree[n.fatherId]&&(n.father=o),n.bindTree=this;for(var s=(o.children||[]).length<=1?0:n.outerHeight,h=n;h;){var d=h.fatherId,c=this.nodesRef[d];d&&c?(c.childrenSumHeight+=s,h=c):h=null}return this.shakeTree(),this.draw(),n.id},t.prototype.shakeTree=function(){for(var t=this,e=[{info:{x:0,fatherY:0,fatherX:0},items:Object.keys(this.tree).map((function(e){return t.nodesRef[e]}))}],i=[],n=[],s=[],r=function(){var t=e.shift(),r=t.info,h=t.items,a=0;h.forEach((function(t,e){a+=t.childrenSumHeight}));var d=r.fatherY-a/2,c=1===h.length;h.forEach((function(t,h){var a;c?a=r.fatherY:(a=d+t.childrenSumHeight/2,d+=t.childrenSumHeight),t.x=r.x,t.y=a,i.push([t,{x:r.x,y:a}]),n.push([t,{x:r.x,y:a}]),r.father&&s.push([r.fatherX+r.father.boxWidth,r.fatherY,r.x,a]),t.state,o.Edit;var l=t.children;l&&e.push({info:{x:r.x+t.boxWidth+100,fatherY:a,fatherX:r.x,father:t},items:l})}))};e.length>0;)r();this.boardList=i,this.textList=n,this.linkList=s},t.prototype.drawBoard=function(){var t=this,e=this.boardList,o=this.ctx,s=[];o.save();var r={};e.forEach((function(t){var e=t[0];e.selected&&s.push(e),r[e.type]=r[e.type]||{type:e.type,list:[]},r[e.type].list.push(t)})),Object.keys(r).forEach((function(e){var o=r[e];!function(t,e,o){e.save(),t===i.Root?(e.beginPath(),o.forEach((function(t){var i=t[0],o=t[1],s=(i.context,i.boxHeight),r=i.boxWidth,h=(i.outerHeight,o.x),a=o.y;a+=i.boxHeight/2,e.translate(h+n,a-i.boxHeight/2),e.lineWidth=4,e.moveTo(-10,0),e.lineTo(-10,-s/2+6),e.arc(-4,-s/2+6,6,Math.PI,1.5*Math.PI),e.lineTo(r-n-6,-s/2),e.arc(r-n-6,-s/2+6,6,1.5*Math.PI,2*Math.PI),e.lineTo(r-n,s/2-6),e.arc(r-n-6,s/2-6,6,2*Math.PI,.5*Math.PI),e.lineTo(-4,s/2),e.arc(-4,s/2-6,6,Math.PI/2,Math.PI),e.lineTo(-10,0),e.translate(-(h+n),-(a-i.boxHeight/2))})),e.closePath(),e.stroke(),e.fillStyle="white",e.fill()):t===i.Node&&(e.beginPath(),o.forEach((function(t){var i=t[0],o=t[1],s=(i.context,i.boxHeight),r=(i.boxWidth,i.outerHeight,o.x),h=o.y;e.translate(r+n,h-i.boxHeight/2),e.lineCap="round",e.lineWidth=2,e.moveTo(-10,s/2),e.lineTo(i.boxWidth-n,s/2),e.translate(-(r+n),-(h-i.boxHeight/2))})),e.closePath(),e.stroke()),e.restore()}(o.type,t.ctx,o.list)})),o.restore(),o.save(),null==s||s.forEach((function(e){t.ctx.fillStyle="rgba(0,102,255,0.2)",e.type===i.Root?t.ctx.fillRect(e.x,e.y-e.boxHeight/2,e.boxWidth,e.boxHeight):t.ctx.fillRect(e.x,e.y-e.boxHeight,e.boxWidth,e.boxHeight)})),o.restore(),window.debug&&e.forEach((function(e){var i=e[0],s=e[1],r=s.x,h=s.y;o.save(),o.fillStyle="red",o.translate(r,h),o.fillRect(-2,-2,4,4),o.restore(),o.save(),o.fillStyle="red",o.translate(r+n,h-i.boxHeight/2),t.ctx.strokeStyle="red",o.strokeRect(-10,-i.childrenSumHeight/2,i.boxWidth,i.childrenSumHeight),o.restore(),o.save(),o.translate(r,h),o.translate(n,-i.boxHeight/2),o.strokeRect(0,-i.contextHeight/2,i.contextWidth,i.contextHeight),o.restore(),o.save(),o.strokeStyle="grey",o.translate(r,h),o.translate(-10,-i.boxHeight-10),o.strokeRect(0,0,i.outerWidth,i.outerHeight),o.restore(),o.save(),o.strokeStyle="yellow",o.translate(r,h),o.translate(0,-i.boxHeight),o.strokeRect(0,0,i.boxWidth,i.boxHeight),o.restore(),o.save(),o.translate(r+n,h-i.boxHeight/2),t.ctx.fillStyle="red",o.font="10px Arial",o.fillText(i.childrenSumHeight.toFixed(2).toString(),i.boxWidth,20-i.boxHeight),o.fillText(i.outerHeight.toFixed(2).toString(),i.boxWidth,20-i.boxHeight+10),o.fillText(i.x.toFixed(0).toString()+","+(i.y||0).toFixed(0).toString()+" ",i.boxWidth,20-i.boxHeight+20),o.translate(-(r+n),-(h-i.boxHeight/2)),o.restore()}))},t.prototype.drawText=function(){var t=this,e=this.textList,o=this.ctx;o.save(),o.textAlign="left",o.textBaseline="middle",e.forEach((function(e){var s=e[0],r=e[1];if(s===t.editoringNode)return!1;var h=r.x,a=r.y;s.type===i.Root&&(a+=s.boxHeight/2),o.translate(h+n,a-s.boxHeight/2);var d=s.context;s.boxHeight,s.boxWidth,s.outerHeight,o.font="14px Arial",o.fillText(d,0,0),o.translate(-(h+n),-(a-s.boxHeight/2))})),o.restore()},t.prototype.drawLink=function(){var t=this.linkList,e=this.ctx;e.save(),e.beginPath(),t.forEach((function(t){var i=t[0],o=t[1],n=t[2],s=t[3],r=Math.abs(s-o),h=(i+n)/2,a=s<o;e.moveTo(i,o),e.lineTo(h-6,o),r/2>=6?(e.quadraticCurveTo(h,o,h,o+(a?-6:6)),e.lineTo(h,s+(a?6:-6)),e.quadraticCurveTo(h,s,h+6,s)):e.bezierCurveTo(h,o,h,s,h+6,s),e.lineTo(n,s)})),e.stroke(),e.closePath()},t.prototype.updateEditor=function(){var t=this.editoringNode,e=window.devicePixelRatio||1;if(t){var o=this.ctx.getTransform(),s=o.a,r=o.e,a=o.f,d=t.x,c=t.y,l=t.contextWidth,f=t.contextHeight,x=[(r+d*s)/e,(a+c*s)/e],u=x[0],v=x[1],p=0,g=0;t.type===i.Node&&(p=n*(s/e),g-=n*(s/e)),h.show(u+p,v+g,l,f,s,t)}else h.hide()},t.prototype.draw=function(){this.drawBoard(),this.drawText(),this.drawLink(),this.updateEditor()},t}(),c=function(){function t(t){this.dpr=window.devicePixelRatio||1,this.scale=this.dpr,this.size=t,this.offset={x:t.width/2*this.scale,y:t.height/2*this.scale},this.events={};var e=this.canvas=document.createElement("canvas");this.ctx=e.getContext("2d"),window.ctx=this.ctx,this.adjustCanvs(e,t),this.bindEvent();var i=window.testNode=new d(this,{x:0,y:0,context:"Hello"}),n=0;n=i.addNode({context:"Robin Ma"}),n=i.addNode({context:"CKY"}),i.addNode({context:"Name: kaiyue"},n),n=i.addNode({context:"Mofei Zhu"}),i.addNode({context:"Name: Mofei"},n),i.addNode({context:"Sex: Fame"},n),n=i.addNode({context:"Age: 18"},n),n=i.addNode({context:"Mll"}),i.nodesRef[n].state=o.Edit,this.nodeTrees=[i],n=i.addNode({context:"Mll"})}return t.prototype.adjustCanvs=function(t,e){t.style.width=e.width+"px",t.style.height=e.height+"px",t.width=e.width*this.dpr,t.height=e.height*this.dpr,this.ctx.translate(this.offset.x,this.offset.y),this.ctx.scale(this.dpr,this.dpr)},t.prototype.bindEvent=function(){var t=this,e=this.canvas,n="DONE",s=null,r=null,h=null,a=null;e.addEventListener("mousedown",(function(t){n="PREPARE",h=s=t.offsetX,a=r=t.offsetY})),e.addEventListener("mousemove",(function(e){if("PREPARE"===n||"MOVING"===n){var o=t,s=o.dpr,r=o.scale,d=(o.offset,e.offsetX-h),c=e.offsetY-a,l=r/s;a=e.offsetY,h=e.offsetX,n="MOVING",t.ctx.translate(d/l,c/l),t.draw()}else{var f=(e.offsetX*t.dpr-t.offset.x)/t.scale,x=(e.offsetY*t.dpr-t.offset.y)/t.scale,u=null;t.nodeTrees.forEach((function(t){for(var e=t.tree,o=[Object.keys(e).map((function(t){return e[t]}))];o.length>=1;)for(var n=0,s=o.pop();n<s.length;n++){var r=s[n],h=Math.max(Math.abs(r.x),0)<Math.abs(f),a=Math.abs(r.y||0)<Math.abs(x)+r.outerHeight,d=r.children;if(h&&a){var c=f>=r.x&&f<=r.x+r.boxWidth,l=r.type===i.Root?r.boxHeight/2:0,v=x>=r.y-r.boxHeight+l&&x<=r.y+l;if(c&&v){u=r,o.length=0;break}d&&o.push(d)}}})),t.canvas.style.cursor=u?"pointer":"default",t.hover=u}})),e.addEventListener("mouseup",(function(e){e.preventDefault(),n="DONE",h=a=null;var i=t.ctx.getTransform();t.scale=i.a,t.offset={x:i.e,y:i.f}})),e.addEventListener("wheel",(function(e){var i=t,o=i.dpr,n=i.scale,s=i.offset;e.preventDefault();var r=Math.pow(1.01,-e.deltaY),h=n/o;ctx.setTransform(n,0,0,n,s.x,s.y),t.ctx.translate(-s.x/n+e.offsetX/h,-s.y/n+e.offsetY/h),t.ctx.scale(r,r),t.ctx.translate(-(-s.x/n+e.offsetX/h),-(-s.y/n+e.offsetY/h));var a=t.ctx.getTransform();t.scale=a.a,t.offset={x:a.e,y:a.f},t.draw()})),e.addEventListener("click",(function(e){var i,n,h;if(t.hover&&t.selected===t.hover?(t.hover.state=o.Edit,t.editItem=t.hover):t.hover!==t.editItem&&(null===(i=t.editItem)||void 0===i||(i.state=o.Default),t.editItem=null),null===(n=t.selected)||void 0===n||(n.selected=!1),Math.abs(e.offsetX-s)>5||Math.abs(e.offsetY-r)>5)return!1;t.selected=t.hover,null===(h=t.selected)||void 0===h||(h.selected=!0),t.draw()}))},t.prototype.draw=function(){var t=this.ctx;if(t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="#f3f3f4",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore(),window.debug){this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="red",this.ctx.lineWidth=2,this.ctx.moveTo(0,-5),this.ctx.lineTo(0,5),this.ctx.moveTo(-5,0),this.ctx.lineTo(5,0),this.ctx.stroke(),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.strokeStyle="#ddd";for(var e=Math.round(this.size.width/10),i=-e;i<e;i+=1)this.ctx.moveTo(-10*i,-this.size.height),this.ctx.lineTo(-10*i,this.size.height);var o=Math.round(this.size.height/10);for(i=-o;i<o;i+=1)this.ctx.moveTo(-this.size.width,-10*i),this.ctx.lineTo(this.size.width,-10*i);this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()}(this.nodeTrees||[]).forEach((function(t){t.draw()}))},t}(),l=function(t){var e=getComputedStyle(t),i={width:parseFloat(e.width),height:parseFloat(e.height)};this.coreCanvas=new c(i),this.canvas=this.coreCanvas.canvas,this.ctx=this.coreCanvas.ctx,this.coreCanvas.draw()},f=function(t,e){this.container=document.getElementById(t),this.graph=new l(this.container),console.log("Hello Athena!"),this.container.appendChild(this.graph.canvas)}})(),AthenaMindmap=e})();
//# sourceMappingURL=athena-mindmap.min.js.map